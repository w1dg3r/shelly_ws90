<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <style>
        .log-container {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        #last_msg {
            width: 100%;
            height: 200px;
            font-family: monospace;
            white-space: pre;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1 data-i18n="settings.title">MQTT Broker Settings</h1>
    <fieldset>
        <legend>Broker Details</legend>

        <div class="field row">
            <label for="host">Host</label>
            <input id="host" type="text" value="192.168.1.182" />
        </div>

        <div class="field row">
            <label for="port">Port</label>
            <input id="port" type="number" value="1883" />
        </div>

        <div class="field row">
            <label for="user">Username</label>
            <input id="user" type="text" value="" />
        </div>

        <div class="field row">
            <label for="pass">Password</label>
            <input id="pass" type="password" value="" />
        </div>

        <div class="field row">
            <label for="topic">Topic</label>
            <input id="topic" type="text" value="shelly/weather/ws90" />
        </div>
    </fieldset>

    <button id="save" class="homey-button-primary">Save</button>
    <p id="message"></p>

    <div class="log-container">
        <h3>Debug</h3>
        <div class="field row">
            <label for="debug">Enable Last Message Log</label>
            <input id="debug" type="checkbox" />
        </div>

        <textarea id="last_msg" readonly placeholder="Last MQTT Message will appear here..."></textarea>
    </div>

    <script>
        function onHomeyReady(Homey) {
            Homey.get('mqtt_host', (err, host) => { if (host) document.getElementById('host').value = host; });
            Homey.get('mqtt_port', (err, port) => { if (port) document.getElementById('port').value = port; });
            Homey.get('mqtt_user', (err, user) => { if (user) document.getElementById('user').value = user; });
            Homey.get('mqtt_pass', (err, pass) => { if (pass) document.getElementById('pass').value = pass; });
            Homey.get('mqtt_topic', (err, topic) => { if (topic) document.getElementById('topic').value = topic; });

            // Debug settings
            Homey.get('debug_log', (err, state) => {
                document.getElementById('debug').checked = !!state;
            });
            Homey.get('last_message', (err, msg) => {
                if (msg) document.getElementById('last_msg').value = msg;
            });

            // Listen for checks
            document.getElementById('debug').addEventListener('change', (e) => {
                Homey.set('debug_log', e.target.checked);
            });

            // Poll for last message updates every 2 seconds if enabled
            setInterval(() => {
                if (document.getElementById('debug').checked) {
                    Homey.get('last_message', (err, msg) => {
                        if (msg) document.getElementById('last_msg').value = msg;
                    });
                }
            }, 2000);

            document.getElementById('save').addEventListener('click', () => {
                Homey.set('mqtt_host', document.getElementById('host').value);
                Homey.set('mqtt_port', document.getElementById('port').value);
                Homey.set('mqtt_user', document.getElementById('user').value);
                Homey.set('mqtt_pass', document.getElementById('pass').value);
                Homey.set('mqtt_topic', document.getElementById('topic').value);

                document.getElementById('message').innerText = 'Saved! Restart app to apply.';
                setTimeout(() => document.getElementById('message').innerText = '', 3000);
            });

            Homey.ready();
        }
    </script>
</body>

</html>